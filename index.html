<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Página con 2 botones - QR</title>
  <style>
    :root{ --bg:#f6f7fb; --card:#fff; --accent:#2b6cb0; --muted:#666;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:var(--bg);display:flex;min-height:100vh;align-items:center;justify-content:center}
    .card{background:var(--card);padding:28px;border-radius:12px;box-shadow:0 8px 30px rgba(20,30,40,0.08);width:min(720px,96%);text-align:center}
    h1{margin:0 0 6px;font-size:20px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .buttons{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:18px}
    .btn{appearance:none;border:0;padding:12px 18px;border-radius:10px;font-weight:600;cursor:pointer;background:var(--accent);color:white;min-width:150px}
    .btn.secondary{background:#4a5568}
    .preview{border-radius:10px;overflow:hidden;border:1px solid #e6e9ef;background:#fff;max-width:100%;height:420px;display:grid;place-items:center;position:relative}
    .preview img{max-width:100%;max-height:100%;display:block}
    .preview .msg{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,0.6);color:#fff;padding:6px 10px;border-radius:8px;font-size:13px;display:none}
    .preview.loading::after{content:'Cargando…';position:absolute;right:12px;top:12px;background:rgba(0,0,0,0.6);color:#fff;padding:6px 10px;border-radius:8px;font-size:13px}
    .preview.error .msg{display:block}
    .small{font-size:13px;color:var(--muted);margin-top:12px}
    footer{margin-top:14px;font-size:13px;color:#8b8f97}
    @media (max-width:480px){ .preview{height:260px} }
  </style>
</head>
<body>
  <main class="card">
    <h1>Página desde QR</h1>
    <p class="lead">Toca un botón para ver la imagen correspondiente. Se abrirá en la vista previa o en nueva pestaña (según tu elección).</p>

    <!-- BOTONES -->
    <div class="buttons">
      <!-- usa raw.githubusercontent.com con /<owner>/<repo>/<branch>/<path> -->
      <button class="btn" data-image="https://raw.githubusercontent.com/adisenoOrt/QRPANACEA/main/Ensamble%20Bandeja%201%20-%20Antares.JPG" id="btn1">Ver imagen 1</button>
      <button class="btn secondary" data-image="https://via.placeholder.com/1200x800?text=Imagen+2" id="btn2">Ver imagen 2</button>
    </div>

    <!-- PREVIEW (muestra la imágen dentro de la misma página) -->
    <div class="preview" id="preview">
      <img src="https://via.placeholder.com/1200x800?text=Imagen+1" alt="Previsualización" id="previewImg">
      <div class="msg" id="previewMsg">No se pudo cargar la imagen</div>
    </div>

    <div class="small">
      ¿Quieres que el QR abra esta página directamente y que desde aquí se elija la imagen? ¡Así funciona.
    </div>

    <footer>
      Si prefieres que los botones abran las imágenes en otra pestaña, verás instrucciones más abajo.
    </footer>
  </main>

  <script>
    // Elementos
    const btns = document.querySelectorAll('.btn');
    const previewImg = document.getElementById('previewImg');
    const preview = document.getElementById('preview');
    const previewMsg = document.getElementById('previewMsg');

    // Placeholder y control de URL actual
    const placeholder = 'https://via.placeholder.com/1200x800?text=No+se+encuentra+la+imagen';
    let currentObjectUrl = null;

    // Limpia object URL anterior si existe
    function revokeCurrentObjectUrl() {
      if (currentObjectUrl) {
        URL.revokeObjectURL(currentObjectUrl);
        currentObjectUrl = null;
      }
    }

    // Intenta cargar la imagen usando fetch -> blob -> objectURL.
    // Esto a menudo evita problemas al asignar directamente la URL remota
    // y facilita detectar errores (404/403) anteriormente silenciados.
    async function loadImageToPreview(url) {
      // marca como cargando
      preview.classList.add('loading');
      preview.classList.remove('error');
      previewMsg.textContent = '';

      // evita fugas de memoria
      revokeCurrentObjectUrl();

      try {
        // intento de fetch con timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 12000); // 12s timeout

        const resp = await fetch(url, { mode: 'cors', signal: controller.signal });
        clearTimeout(timeoutId);

        if (!resp.ok) {
          throw new Error('HTTP ' + resp.status + ' ' + resp.statusText);
        }

        const blob = await resp.blob();

        // Opcional: comprobar tipo MIME simple para ver si realmente es imagen
        if (!blob.type.startsWith('image/')) {
          throw new Error('El recurso no es una imagen (mime: ' + blob.type + ')');
        }

        // crea objectURL y asigna
        currentObjectUrl = URL.createObjectURL(blob);
        previewImg.src = currentObjectUrl;
        previewImg.alt = 'Imagen cargada';
        preview.classList.remove('error');
      } catch (err) {
        // En caso de error, muestra mensaje y placeholder
        console.warn('Error cargando imagen para preview:', err);
        preview.classList.add('error');
        previewMsg.textContent = 'No se pudo cargar la imagen. Puedes abrirla en nueva pestaña para ver el error real.';
        previewImg.src = placeholder;
        previewImg.alt = 'No disponible';
      } finally {
        preview.classList.remove('loading');
      }
    }

    // Manejadores de eventos para botones
    btns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const url = btn.dataset.image;
        // guarda la URL para debug
        previewImg.dataset.requestedUrl = url;
        // intenta cargar via fetch+blob
        loadImageToPreview(url);
      });

      // doble click abre directamente en nueva pestaña
      btn.addEventListener('dblclick', (e) => {
        const url = btn.dataset.image;
        window.open(url, '_blank');
      });
    });

    // Manejo de error/carga por si el src directo falla (seguridad extra)
    previewImg.addEventListener('error', () => {
      // Si falla al mostrar el objectURL o src directo, ya hemos intentado fallback
      if (!preview.classList.contains('error')) {
        preview.classList.add('error');
        previewMsg.textContent = 'Error mostrando la imagen. Abre en nueva pestaña para depurar.';
        previewImg.src = placeholder;
      }
    });

    // limpiar object URLs al salir de la página
    window.addEventListener('beforeunload', revokeCurrentObjectUrl);
  </script>
</body>
</html>
